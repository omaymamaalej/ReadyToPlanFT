<nb-layout>
  <nb-layout-column>
    <div class="dashboard-container">
      
      <nb-card class="dashboard-header">
        <nb-card-header>
          <div class="header-content">
            <h1>üìä Dashboard</h1>
            <p>Overview of presentations and statistics</p>
          </div>
        </nb-card-header>
      </nb-card>

      <div class="dashboard-grid">
        
        <!-- Left Column - Shared Presentations -->
        <div class="left-column">
          <nb-card class="presentations-card">
            <nb-card-header>
              <h3>üåê Shared Presentations</h3>
              <p>List of publicly accessible presentations</p>
            </nb-card-header>
            <nb-card-body>

              <!-- Barre de recherche + filtres -->
              <div class="filters-container">
                <input nbInput fullWidth placeholder="üîç Search by title or creator"
                      [(ngModel)]="searchTerm" (input)="applyFilters()" />

                <nb-select placeholder="Filter by Audience" [(selected)]="selectedAudience" (selectedChange)="applyFilters()">
                  <nb-option value="">All Audiences</nb-option>
                  <nb-option value="STUDENTS">Students</nb-option>
                  <nb-option value="TEACHERS">Teachers</nb-option>
                  <nb-option value="PROFESSIONALS">Professionals</nb-option>
                </nb-select>

                <nb-select placeholder="Filter by Satisfaction" [(selected)]="selectedSatisfaction" (selectedChange)="applyFilters()">
                  <nb-option value="">All</nb-option>
                  <nb-option value="Satisfied">Most Satisfied</nb-option>
                  <nb-option value="NotSatisfied">Not Satisfied</nb-option>
                  <nb-option value="NotRated">Not Rated</nb-option>
                </nb-select>
              </div>


              <div class="table-responsive">
                <table class="modern-table">
                  <thead>
                    <tr>
                      <th>Fav</th>
                      <th>Created By</th>
                      <th>Title</th>
                      <th>Audience</th>
                      <th>Satisfaction</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let course of filteredCourses">

                      <!-- Favorite -->
                      <td class="fav-cell">
                        <nb-icon 
                          [icon]="course.isFavorite ? 'star' : 'star-outline'" 
                          status="warning"
                          class="favorite-icon"
                          (click)="toggleFavoriteFromDashboard(course)"
                          [attr.title]="course.isFavorite ? 'Remove from favorites' : 'Add to favorites'">
                        </nb-icon>
                      </td>
                      
                      <td class="creator-cell">
                        <div class="user-info">
                          <nb-icon icon="person-outline"></nb-icon>
                          <span>{{ getCreatedBy(course) }}</span>
                        </div>
                      </td>

                      <td>{{ course.title }}</td>
                      <td>
                        <span class="audience-badge">{{ course.targetAudience }}</span>
                      </td>

                      <td>
                        <div class="satisfaction-counts">
                          <span class="satisfied-count">‚úÖ {{ course?.satisfiedCount || 0 }}</span> /
                          <span class="not-satisfied-count">‚ùå {{ course?.notSatisfiedCount || 0 }}</span>
                        </div>
                      </td>

                      <td class="action-cell">
                        <div class="actions-column">

                          <button nbButton size="tiny" status="primary" 
                                  (click)="viewPresentation(course)" 
                                  [disabled]="course.loadingPresentation" 
                                  title="View Presentation">
                            <nb-icon *ngIf="!course.loadingPresentation" icon="eye-outline"></nb-icon>
                            <div *ngIf="course.loadingPresentation" class="spinner">
                              <div class="blob blob-0"></div>
                              <div class="blob blob-1"></div>
                              <div class="blob blob-2"></div>
                              <div class="blob blob-3"></div>
                              <div class="blob blob-4"></div>
                              <div class="blob blob-5"></div>
                            </div>
                          </button>

                          <!-- Satisfait -->
                          <button nbButton size="tiny" status="success" ghost 
                                  (click)="evaluateCourse(course.id, 3)" 
                                  [disabled]="course.userSatisfaction === 3" 
                                  title="Satisfied">
                            <nb-icon icon="smiling-face-outline"></nb-icon>
                          </button>

                          <!-- Non satisfait -->
                          <button nbButton size="tiny" status="danger" ghost 
                                  (click)="evaluateCourse(course.id, 1)" 
                                  [disabled]="course.userSatisfaction === 1" 
                                  title="Not Satisfied">
                            <nb-icon icon="alert-circle-outline"></nb-icon>
                          </button>
                        </div>
                      </td>

                    </tr>
                  </tbody>
                </table>
              </div>

              
              <div *ngIf="filteredCourses.length === 0" class="no-data">
                <nb-icon icon="file-text-outline" class="no-data-icon"></nb-icon>
                <p>No shared presentations available at the moment</p>
              </div>
            </nb-card-body>
          </nb-card>
        </div>

        <!-- Right Column - Statistics -->
        <div class="right-column">
          
          <!-- Satisfaction Statistics Card -->
          <nb-card class="stats-card">
            <nb-card-header>
              <h3>üìà Satisfaction Statistics</h3>
              <p>Distribution of course ratings</p>
            </nb-card-header>
            <nb-card-body>
              <div *ngIf="stats" class="chart-container">
                <ngx-charts-pie-chart
                  [results]="[
                    { name: 'Satisfied', value: stats.Satisfied || 0 },
                    { name: 'Not Satisfied', value: stats.NotSatisfied || 0 },
                    { name: 'Not Rated', value: stats.NotRated || 0 }
                  ]"
                  [legend]="true"
                  [doughnut]="true"
                  [gradient]="false"
                  [scheme]="colorScheme">
                </ngx-charts-pie-chart>
                
                <div class="stats-numbers">
                  <div class="stat-item">
                    <span class="stat-value">{{ totalCourses }}</span>
                    <span class="stat-label">Total Courses</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ stats.Satisfied || 0 }}</span>
                    <span class="stat-label">Satisfied</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ publicCourses.length }}</span>
                    <span class="stat-label">Shared</span>
                  </div>
                </div>
              </div>
            </nb-card-body>
          </nb-card>

          <!-- Users Card -->
          <nb-card class="users-card">
            <nb-card-header>
              <h3>üë• User Statistics</h3>
              <p>Platform user activity</p>
            </nb-card-header>
            <nb-card-body>
              <div class="users-stats">
                <div class="user-stat">
                  <div class="stat-icon">
                    <nb-icon icon="people-outline"></nb-icon>
                  </div>
                  <div class="stat-content">
                    <span class="stat-number">{{ userStats.totalUsers || 0 }}</span>
                    <span class="stat-label">Total Users</span>
                  </div>
                </div>
                
                <div class="user-stat">
                  <div class="stat-icon">
                    <nb-icon icon="person-add-outline"></nb-icon>
                  </div>
                  <div class="stat-content">
                    <span class="stat-number">{{ userStats.activeUsers || 0 }}</span>
                    <span class="stat-label">Active Users</span>
                  </div>
                </div>
                
                <div class="user-stat">
                  <div class="stat-icon">
                    <nb-icon icon="file-text-outline"></nb-icon>
                  </div>
                  <div class="stat-content">
                    <span class="stat-number">{{ userStats.coursesCreated || 0 }}</span>
                    <span class="stat-label">Courses Created</span>
                  </div>
                </div>
              </div>
            </nb-card-body>
          </nb-card>

        </div>
      </div>

    </div>
  </nb-layout-column>
</nb-layout>
